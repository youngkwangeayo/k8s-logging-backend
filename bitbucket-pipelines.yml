
#  ==============  Î†àÌè¨ÏßÄÌÜ†Î¶¨ ÌôòÍ≤Ω Î≥ÄÏàò  ==============
#   AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY,  AWS_DEFAULT_REGION       # CLI
#   AWS_ECR_REPO, AWS_ECR_NAME                                          # ECR DEV,PROD
# =================================================
#  ÎÇ¥Ïö©
# =================================================
image: atlassian/default-image:2

pipelines:
  tags:
    '*.*.*':
      - step:
          name: üèóÔ∏è Build & Push Image to ECR (DEV)
          services:
            - docker
          script:
            # Docker Ïù¥ÎØ∏ÏßÄ ÎπåÎìú
            - docker build -t $AWS_ECR_NAME_DEV:$BITBUCKET_TAG -t $AWS_ECR_NAME_DEV .
            # ECRÏóê REPO ÌÉúÍ∑∏ ÏßÄÏ†ï
            - docker tag $AWS_ECR_NAME_DEV:$BITBUCKET_TAG $AWS_ECR_REPO_DEV/$AWS_ECR_NAME_DEV:$BITBUCKET_TAG
            - docker tag $AWS_ECR_NAME_DEV:$BITBUCKET_TAG $AWS_ECR_REPO_DEV/$AWS_ECR_NAME_DEV:latest
            # ECRÏóê Ìë∏Ïãú
            - pipe: atlassian/aws-ecr-push-image:2.6.0
              variables:
                AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID 
                AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY
                AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION 
                IMAGE_NAME: $AWS_ECR_NAME_DEV
                TAGS: "$BITBUCKET_TAG latest"
      # - parallel:
      #   - step:
      #       name: üöÄ Deploy to ECS (DEV)
      #       image: amazon/aws-cli:2.30.3
      #       script:
      #         - echo "‚úÖ HELLO!"
      #   - step:
      #       name: üöÄ[Cron] Deploy to ECS (DEV)
      #       image: amazon/aws-cli:2.30.3
      #       script:
      #         - echo "‚úÖ HELLO!"